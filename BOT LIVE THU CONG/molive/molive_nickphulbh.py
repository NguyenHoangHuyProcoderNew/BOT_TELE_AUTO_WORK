# IMPORT C√ÅC TH∆Ø VI·ªÜN C·∫¶N THI·∫æT
import os
import time
import logging
import threading
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from time import sleep
import telebot
import sys
import pyperclip
from selenium.common.exceptions import NoSuchElementException
logging.basicConfig(level=logging.CRITICAL)  # Ch·ªâ in th√¥ng b√°o l·ªói nghi√™m tr·ªçng
import datetime
now = datetime.datetime.now()
from selenium.common.exceptions import TimeoutException
from colorama import Fore, Style, init
from telebot import types
# NH·∫¨P FILE DYLIB CH·ª®A C√ÅC H√ÄM QUAN TR·ªåNG
from dylib import dylib

# C·∫§U H√åNH WEBDRIVER
chromedriver_path = r'D:\\BOT_TELE_AUTO_WORK\\BOT LIVE THU CONG\\chrome_driver\\chromedriver.exe'

options = Options()
options.add_argument('--log-level=3')  # V√¥ hi·ªáu h√≥a th√¥ng b√°o c·ªßa Selenium
options.add_argument('--user-data-dir=D:\\BOT_TELE_AUTO_WORK\\BOT LIVE THU CONG\\du lieu trinh duyet')

service = Service(chromedriver_path)
service_log_path = os.path.devnull
service = Service(chromedriver_path, service_log_path=service_log_path)

# KHAI B√ÅO APT TOKEN BOT TELEGRAM
API_TOKEN = '7371036517:AAEB8PtQRtSrvDOxQUUW2su7ObGso6ltq8w'  # TOKEN C·ª¶A BOT
bot = telebot.TeleBot(API_TOKEN)

user_id = '5634845912' # ID C·ª¶A NG∆Ø·ªúI D√ôNG

# TH√îNG TIN T√ÄI KHO·∫¢N LIVE
ten_tai_khoan = "NICK PHU LBH"
id_tiktok = "nammapsang_keorank"
select_account = "#tiktok_account > option:nth-child(2)"

# Kh·ªüi t·∫°o colorama
init()

linknguon = None

########## TR·ªû V·ªÄ MENU CH√çNH #########
home = telebot.types.ReplyKeyboardMarkup(True).add("ƒê·ªïi IP").add("M·ªü live").add("T·∫Øt live").add("Check view")
def back_home(message):
    text = "VUI L√íNG CH·ªåN üëá"
    bot.send_message(message.chat.id, text, reply_markup=home)

############# L·ª∞A CH·ªåN NGU·ªíN LIVE & M·ªû LIVE ############
# H√ÄM Y√äU C·∫¶U NG∆Ø·ªúI D√ôNG CH·ªåN NGU·ªíN CHO PHI√äN LIVE
def ask_source_live_nickphulbh(message):
    print(f"\n============= M·ªû LIVE T√ÄI KHO·∫¢N | {Fore.GREEN}{ten_tai_khoan}{Style.RESET_ALL} | ID Tiktok: {id_tiktok} =============")

    dylib.print_red("ƒêang ƒë·ª£i ng∆∞·ªùi d√πng ch·ªçn ngu·ªìn cho phi√™n live...")
    select_source_live = types.ReplyKeyboardMarkup(True).add('H·ªíI CHI√äU').add('QU·ª≤NH EM').add('Tr·ªü l·∫°i menu ch√≠nh')
    text = "Vui l√≤ng l·ª±a ch·ªçn ngu·ªìn cho phi√™n live"
    bot.send_message(message.chat.id, text, reply_markup=select_source_live)
    bot.register_next_step_handler(message, main_molive_nickphulbh)

# H√ÄM M·ªû LIVE
def main_molive_nickphulbh(message):
    global linknguon

    if message.text == "H·ªíI CHI√äU":
        linknguon = "https://drive.google.com/file/d/1PrRqUCTGm0nseYKJwARZYuCmsxMc-T7k/view?usp=drivesdk" # NGU·ªíN H·ªíI CHI√äU
        dylib.print_red("Ng∆∞·ªùi d√πng ƒë√£ ch·ªçn ngu·ªìn H·ªíI CHI√äU, ti·∫øn h√†nh m·ªü phi√™n live v·ªõi ngu·ªìn H·ªíI CHI√äU"); dylib.bot_reply(user_id, f"Ti·∫øn h√†nh m·ªü phi√™n live t√†i kho·∫£n {ten_tai_khoan} v·ªõi ngu·ªìn H·ªíI CHI√äU")
    elif message.text == "QU·ª≤NH EM":
        linknguon = "https://drive.google.com/file/d/1QEX0hXjZZEvY6IjAaBzP7hhuzRop05Gz/view?usp=sharing" # NGU·ªíN QU·ª≤NH EM
        dylib.print_red("Ng∆∞·ªùi d√πng ƒë√£ ch·ªçn ngu·ªìn QU·ª≤NH EM, ti·∫øn h√†nh m·ªü phi√™n live v·ªõi ngu·ªìn QU·ª≤NH EM"); dylib.bot_reply(user_id, f"Ti·∫øn h√†nh m·ªü phi√™n live t√†i kho·∫£n {ten_tai_khoan} v·ªõi ngu·ªìn QU·ª≤NH EM")
    elif message.text == "Tr·ªü l·∫°i menu ch√≠nh":
        back_home(message)
        return

    # KH·ªûI T·∫†O WEB DRIVER
    driver = webdriver.Chrome(service=service, options=options) ; dylib.print_green("KH·ªûI T·∫†O WEB DRIVER")

    # IN V√Ä G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG
    dylib.print_green_and_send_message(user_id, "M·ªü trang web livestream")

    # M·ªû WEB LIVESTREAM
    driver.get('https://autolive.me/tiktok')

    # KI·ªÇM TRA XEM TRANG WEB LOAD XONG CH∆ØA
    try:
        # IN RA M√ÄN H√åNH
        dylib.print_green_and_send_message(user_id, "ƒêang load trang web livestream...")

        # ƒê·ª¢I PH·∫¶N T·ª¨ C·ª¶A WEB XU·∫§T HI·ªÜN
        # SAU KHI PH·∫¶N T·ª¨ XU·∫§T HI·ªÜN => G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG V√Ä IN RA M√ÄN H√åNH ƒê·ªÇ TH√îNG B√ÅO
        WebDriverWait(driver, 100).until(EC.presence_of_element_located((By.XPATH, '/html/body/div[1]/div[3]/div/div/div[1]/div[1]/div/div[2]/h3/b'))) ; dylib.print_yellow_and_send_message(user_id, "Load website livestream th√†nh c√¥ng")
    except TimeoutError:
        # IN V√Ä G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG N·∫æU TH·∫§T B·∫†I
        dylib.print_green_and_send_message(user_id, "C√≥ l·ªói x·∫£y ra khi truy c·∫≠p v√†o trang web livestream, vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi internet c·ªßa m√°y ch·ªß.")

        # ƒê√ìNG CHROME
        driver.quit()

        # K·∫æT TH√öC TI·∫æN TR√åNH
        return

    # TH√îNG B√ÅO X√ìA C·∫§U H√åNH HI·ªÜN T·∫†I
    dylib.print_red_and_send_message(user_id, "Ti·∫øn h√†nh x√≥a c·∫•u h√¨nh c≈©")

    # X√ìA C·∫§U H√åNH C≈®
    try:
        # CLICK V√ÄO N√öT X√ìA C·∫§U H√åNH
        driver.find_element(By.XPATH, '//button[@class="btn btn-circle btn-dark btn-sm waves-effect waves-light btn-status-live" and @data-status="-1" and @data-toggle="tooltip"]').click() ; dylib.print_green("Click v√†o n√∫t x√≥a c·∫•u h√¨nh")

        # ƒê·ª¢I C·∫§U H√åNH ƒê∆Ø·ª¢C X√ìA
        dylib.print_green_and_send_message(user_id, "ƒêang ƒë·ª£i c·∫•u h√¨nh ƒë∆∞·ª£c x√≥a...") ; WebDriverWait(driver, 100).until(EC.presence_of_element_located((By.CSS_SELECTOR, "body > div.notifyjs-corner > div > div.notifyjs-container > div")))

        # KI·ªÇM TRA D·ªÆ LI·ªÜU C·ª¶A TH√îNG B√ÅO KHI CLICK V√ÄO N√öT X√ìA C·∫§U H√åNH
        # L·∫§Y D·ªÆ LI·ªÜU C·ª¶A TH√îNG B√ÅO X√ìA C·∫§U H√åNH
        check_xoacauhinh = driver.find_element(By.CSS_SELECTOR, 'div.text[data-notify-html="text"]')

        # CHUY·ªÇN D·ªÆ LI·ªÜU CHECK ƒê∆Ø·ª¢C TH√ÄNH VƒÇN B·∫¢N
        data_xoacauhinh = check_xoacauhinh.text

        # KI·ªÇM TRA D·ªÆ LI·ªÜU C·ª¶A TH√îNG B√ÅO
        if data_xoacauhinh == "B·∫°n ph·∫£i d·ª´ng lu·ªìng live tr∆∞·ªõc khi x√≥a":
            dylib.print_yellow_and_send_message(user_id, "Kh√¥ng th·ªÉ x√≥a c·∫•u h√¨nh v√¨ c√≥ 1 lu·ªìng live ƒëang ƒë∆∞·ª£c ch·∫°y, vui l√≤ng d·ª´ng live b·∫±ng l·ªánh /tatlive r·ªìi th·ª≠ l·∫°i sau")

            # ƒê√ìNG CHROME
            driver.quit()

            # D·ª™NG TI·∫æN TR√åNH
            return
        else:
            dylib.print_yellow_and_send_message(user_id, "X√≥a c·∫•u h√¨nh th√†nh c√¥ng")
    except NoSuchElementException:
        # IN RA M√ÄN H√åNH V√Ä G·ª¨I TIN NH·∫ÆN
        dylib.print_yellow_and_send_message(user_id, "Hi·ªán t·∫°i kh√¥ng c√≥ c·∫•u h√¨nh")

    # T·∫†O C·∫§U H√åNH M·ªöI
    dylib.print_red_and_send_message(user_id, "T·∫°o c·∫•u h√¨nh m·ªõi")

    # CH·ªåN T√ÄI KHO·∫¢N LIVE
    dylib.print_green("Ch·ªçn t√†i kho·∫£n") ; driver.find_element(By.CSS_SELECTOR, f"{select_account}").click()

    # NH·∫¨P TI√äU ƒê·ªÄ LIVE
    dylib.print_green("Nh·∫≠p ti√™u ƒë·ªÅ live") ; driver.find_element(By.ID, "title").send_keys('k√©o rank Li√™n Qu√¢n')

    # CH·ªåN CH·ª¶ ƒê·ªÄ LIVE
    dylib.print_green("Ch·ªçn ch·ªß ƒë·ªÅ live") ; driver.find_element(By.CSS_SELECTOR, "#topic > option:nth-child(11)").click()

    # CH·ªåN KI·ªÇU LIVE
    dylib.print_green("Ch·ªçn ki·ªÉu live Mobile") ; driver.find_element(By.CSS_SELECTOR, "#formLive > div:nth-child(6) > div > div > div > button:nth-child(2) > i").click()


    # NH·∫¨P LINK NGU·ªíN
    dylib.print_green("Nh·∫≠p link ngu·ªìn cho phi√™n live") ; driver.find_element(By.ID, "url_source").send_keys(linknguon)

    # L∆ØU C·∫§U H√åNH
    dylib.print_green("L∆∞u c·∫•u h√¨nh")

    # KI·ªÇM TRA XEM C·∫§U H√åNH C√ì ƒê∆Ø·ª¢C L∆ØU TH√ÄNH C√îNG HAY KH√îNG
    try:
        # CLICK V√ÄO N√öT L∆ØU C·∫§U H√åNH
        dylib.print_green("Click v√†o n√∫t l∆∞u c·∫•u h√¨nh") ; driver.find_element(By.CSS_SELECTOR, "#formLive > button").click()

        # CHO LOAD L·∫†I TRANG WEB
        driver.refresh()

        # CH·ªú C·∫§U H√åNH ƒê∆Ø·ª¢C L∆ØU L·∫†I
        dylib.bot_reply(user_id, "C·∫•u h√¨nh ho√†n t·∫•t, ƒëang ƒë·ª£i c·∫•u h√¨nh ƒë∆∞·ª£c l∆∞u l·∫°i...") ; WebDriverWait(driver, 100).until(EC.presence_of_element_located((By.XPATH, '/html/body/div[1]/div[3]/div/div/div[1]/div[1]/div/div[1]')))

        # TH√îNG B√ÅO T·∫†O C·∫§U H√åNH M·ªöI TH√ÄNH C√îNG
        dylib.print_yellow_and_send_message(user_id, "C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng")
    except TimeoutError:
        # IN V√Ä G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG
        dylib.print_red_and_send_message(user_id, "L∆∞u c·∫•u h√¨nh th·∫•t b·∫°i, vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi internet m√°y ch·ªß")

    # M·ªû LIVE
    dylib.print_red_and_send_message(user_id, "Ti·∫øn h√†nh m·ªü live")

    # KI·ªÇM TRA XEM C√ì M·ªû LIVE TH√ÄNH C√îNG HAY KH√îNG
    try:
        # CLICK V√ÄO N√öT M·ªû LIVE
        dylib.print_green("Click v√†o n√∫t m·ªü live") ; driver.find_element(By.CSS_SELECTOR, "button.btn.btn-circle.btn-dark.btn-sm.waves-effect.waves-light.btn-status-live[data-status='1'][data-toggle='tooltip'][data-placement='top'][data-original-title='B·∫Øt ƒë·∫ßu live']").click()

        # ƒê·ª¢I TH√îNG B√ÅO M·ªû LIVE TH√ÄNH C√îNG XU·∫§T HI·ªÜN
        WebDriverWait(driver, 100).until(EC.presence_of_element_located((By.CSS_SELECTOR, "body > div.notifyjs-corner > div > div.notifyjs-container > div")))

        data_notify = driver.execute_script('''
        // JavaScript code here
        // ƒêo·∫°n m√£ JavaScript ƒë·ªÉ l·∫•y n·ªôi dung c·ªßa ph·∫ßn t·ª≠
        var element = document.querySelector('div.text[data-notify-html="text"]');
        return element.textContent;
    ''')
        
        if data_notify == "Success":
            dylib.print_yellow_and_send_message(user_id, "M·ªü live th√†nh c√¥ng")
        else:
            dylib.print_yellow_and_send_message(user_id, f"M·ªü live th·∫•t b·∫°i\nTh√¥ng b√°o c·ªßa web:\n{data_notify}")
            driver.quit()
            return
    except TimeoutError:
        # IN V√Ä G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG
        dylib.print_red_and_send_message(user_id, "M·ªü live th·∫•t b·∫°i, vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi internet m√°y ch·ªß")
        
        # ƒê√ìNG CHROME
        driver.quit()

        # K·∫æT TH√öC TI·∫æN TR√åNH
        return
    
    # KI·ªÇM TRA TH·ªúI ƒêI·ªÇM PHI√äN LIVE ƒê∆Ø·ª¢C DI·ªÑN RA
    dylib.print_red_and_send_message(user_id, "Ti·∫øn h√†nh ki·ªÉm tra th·ªùi ƒëi·ªÉm phi√™n live ƒë∆∞·ª£c di·ªÖn ra")
    try:
        # M·ªû PHI√äN LIVE
        dylib.bot_reply(user_id, "Ti·∫øn h√†nh truy c·∫≠p v√†o phi√™n live...") ; dylib.print_green("M·ªü phi√™n live") ; driver.get(f'https://www.tiktok.com/@{id_tiktok}/live')

        # TRUY C·∫¨P PHI√äN LIVE TH√ÄNH C√îNG
        WebDriverWait(driver, 100).until(EC.presence_of_element_located((By.XPATH, '/html/body/div[1]/main/div[3]/div/div[1]/a'))) ;
        dylib.bot_reply(user_id, "Truy c·∫≠p phi√™n live th√†nh c√¥ng, khi n√†o phi√™n live di·ªÖn ra t√¥i s·∫Ω th√¥ng b√°o cho b·∫°n nh√© ^-^") ; dylib.print_yellow("Truy c·∫≠p phi√™n live th√†nh c√¥ng, ti·∫øn h√†nh ki·ªÉm tra")
    except TimeoutException:
        # IN RA M√ÄN H√åNH
        dylib.print_yellow_and_send_message(user_id, "X·∫£y ra s·ª± c·ªë khi truy c·∫≠p phi√™n live, vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi internet")

        # ƒê√ìNG CHROME
        driver.quit()

        # K·∫æT TH√öC TI·∫æN TR√åNH
        return
    
    # H√ÄM KI·ªÇM TRA PHI√äN LIVE
    while True:
        now = datetime.datetime.now()
        try:
            # KI·ªÇM TRA PH·∫¶N T·ª¨ CH·ª®A S·ªê L∆Ø·ª¢NG NG∆Ø·ªúI XEM

            # S·ª¨ D·ª§NG WebDriverWait, N·∫æU TRONG 1 GI√ÇY M√Ä PH·∫¶N T·ª¨ XU·∫§T HI·ªÜN TH√å PHI√äN LIVE ƒê√É ƒê∆Ø·ª¢C M·ªû
            checkview = WebDriverWait(driver, 1).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "#tiktok-live-main-container-id > div.css-1fxlgrb-DivBodyContainer.etwpsg30 > div.css-l1npsx-DivLiveContentContainer.etwpsg31 > div > div.css-wl3qaw-DivLiveContent.e1nhv3vq1 > div.css-1kgwg7s-DivLiveRoomPlayContainer.e1nhv3vq2 > div.css-jvdmd-DivLiveRoomBanner.e10bhxlw0 > div.css-1s7wqxh-DivUserHoverProfileContainer.e19m376d0 > div > div > div.css-1j46cc2-DivExtraContainer.e1571njr9 > div.css-9aznci-DivLivePeopleContainer.e1571njr10 > div > div"))
            )
            dylib.print_yellow_and_send_message(user_id, f"Phi√™n live ƒë√£ ƒë∆∞·ª£c di·ªÖn ra v√†o l√∫c {now.strftime('%d/%m/%Y %H:%M:%S')}")
            
            # ƒê√ìNG TR√åNH DUY·ªÜT CHROME
            driver.quit()

            # K·∫æT TH√öC TI·∫æN TR√åNH
            return
        except TimeoutException:
            # IN RA M√ÄN H√åNH
            dylib.print_green(f"{now.strftime('%d/%m/%Y %H:%M:%S')} - Phi√™n live ch∆∞a d∆∞·ª£c di·ªÖn ra => TI·∫æP T·ª§C KI·ªÇM TRA")

            # L√ÄM M·ªöI L·∫†I PHI√äN LIVE
            driver.refresh()

            # KI·ªÇM TRA XEM PHI√äN LIVE C√ì ƒê∆Ø·ª¢C L√ÄM M·ªöI TH√ÄNH C√îNG HAY KH√îNG SAU KHI L√ÄM M·ªöI
            try:
                WebDriverWait(driver, 100).until(
                    EC.presence_of_element_located((By.XPATH, "/html/body/div[1]/main/div[3]/div/div[1]/a"))
                )
            except TimeoutException:
                # IN RA M√ÄN H√åNH V√Ä G·ª¨I TIN NH·∫ÆN CHO NG∆Ø·ªúI D√ôNG
                dylib.print_yellow_and_send_message(user_id, "C√≥ l·ªói s·∫£y ra khi ki·ªÉm tra phi√™n live, vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi internet")

                # ƒê√ìNG CHROME
                driver.quit()

                return # K·∫æT TH√öC TI·∫æN TR√åNH